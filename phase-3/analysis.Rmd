---
title: "Evolution of the controller of hybrid (soft/rigid) robots"
output: html_notebook
---
```{r}
require(tidyverse)
require(skimr)
```

## Analysis of mutation average step size

### Load data
```{r}
r.dist = read.table("mutation-distance.txt", dec=".", strip.white = T, stringsAsFactors = T, header = T)
```

### Average mutation step size vs. sigma (for genotype space dimension p)
```{r, fig.width=5, fig.height=3}
r.dist %>% ggplot(aes(x=sigma, y=d, col=factor(p))) + geom_line() + ylab("Average mutation step size")
```
### Average mutation step size vs. sigma (for genotype space dimension p)
```{r, fig.width=5, fig.height=3}
r.dist %>% mutate(rd = d/2/sqrt(p)) %>% ggplot(aes(x=sigma, y=rd, col=factor(p))) + geom_line() + ylab("Average mutation rel. step size")
```

## Load and clean evolution data

### Load data
```{r}
r.legged = read.csv2("../phase-1/best-walker-3chunks-6x.csv", dec=".", strip.white = T, stringsAsFactors = T)
r.vsr = read.csv2("../phase-1/best-hybrid-vsr.csv", dec=".", strip.white = T, stringsAsFactors = T)
```

### Clean
Extract key factors.
```{r}
r.legged$type = "legged"
r.legged$softness = factor(str_count(r.legged$solver.mapper.target,"soft"))
r.legged$ctrl = "open"
r.vsr$type = "vsr"
r.vsr$softness = factor((str_count(str_extract(r.vsr$solver.mapper.target.body.shape, "s=\"?([rs.-]+)", group=1),"s")-4)/2)
r.vsr$ctrl = "open"
r.vsr$ctrl[r.vsr$solver.mapper.target.function=="s.f.mlp()"] = "closed"
vars = c("type", "ctrl", "softness", "randomGenerator.seed", "iterations", "evals", "best.fitness.s.task.l.xVelocity")
d1 = rbind(r.vsr[, vars], r.legged[, vars])
d1$type = factor(d1$type)
d1$ctrl = factor(d1$ctrl)
```

The **softness** is defined as follows:

For legged robots, it is the number of soft feet out of 5 total feet.

For VSRs, it corresponds to:
- for 0, 4 out of 12 soft voxels (i.e., 8 are rigid squares)
- for 1, 6 out of 12 soft voxels
- for 2, 8 out of 12 soft voxels
- for 3, 10 out of 12 soft voxels
- for 4, 12 out of 12 soft voxels

## Evolution plot

```{r, fig.width=5, fig.height=2}
d1 %>% group_by(type, ctrl, softness, iterations) %>% summarise_at(vars(best.fitness.s.task.l.xVelocity), list(Q1=~quantile(.,probs=0.25), median=median, Q3=~quantile(.,probs=0.75))) %>% ggplot(aes(iterations,median,col=softness)) + geom_line() + geom_ribbon(aes(ymin=Q1,ymax=Q3,fill=softness),alpha=0.2,color=NA) + facet_wrap(vars(type,ctrl), scales="free") + theme_light() + scale_color_brewer(palette="Set1") + scale_fill_brewer(palette="Set1") + ylab("vx")
```

## Box plots

```{r, fig.width=5, fig.height=2}
d1 %>% group_by(type, ctrl, softness, randomGenerator.seed) %>% arrange(iterations) %>% filter(row_number()==n()) %>% ungroup() %>% group_by(type, ctrl, softness) %>% ggplot(aes(x=softness,y=best.fitness.s.task.l.xVelocity)) + geom_boxplot() + facet_wrap(vars(type,ctrl), scales="free") + theme_light() + scale_color_brewer(palette="Set1") + scale_fill_brewer(palette="Set1") + ylab("vx")
```

# Sections plots

## Load and clean section data

### Load data
```{r}
s.legged = read.csv2("../phase-2/legged-sections.csv", dec=".", strip.white = T, stringsAsFactors = T, colClasses = c(NA, NA, NA, NA, NA, NA, NA, NA, "NULL"))
s.vsr = read.csv2("../phase-2/vsr-sections.csv", dec=".", strip.white = T, stringsAsFactors = T, colClasses = c(NA, NA, NA, NA, NA, NA, NA, NA, "NULL"))
```

### Clean
Extract key factors.
```{r}
s.legged$type = "legged"
s.legged$softness = factor(str_count(s.legged$target,"soft"))
s.legged$ctrl = "open"
s.vsr$type = "vsr"
s.vsr$softness = factor((str_count(str_extract(s.vsr$target, "s=\"?([rs.-]+)", group=1),"s")-4)/2)
s.vsr$ctrl = "open"
s.vsr$ctrl[str_count(s.vsr$target, "s.f.mlp()")>0] = "closed"
d2 = rbind(s.vsr, s.legged)
d2$type = factor(d2$type)
d2$ctrl = factor(d2$ctrl)
```

## Plots

### Actual fitness vs. distance (for type+ctrl, iteration, softness)
```{r, fig.width=5, fig.height=3}
d2 %>% group_by(type, ctrl, softness, iteration, stepIndex, d) %>% summarise_at(vars(pointQ), list(Q1=~quantile(.,probs=0.25), median=median, Q3=~quantile(.,probs=0.75))) %>% ggplot(aes(d,median,col=softness)) + geom_line() + geom_ribbon(aes(ymin=Q1,ymax=Q3,fill=softness),alpha=0.2,color=NA) + facet_grid(factor(iteration)~type+ctrl) + theme_light() + scale_color_brewer(palette="Set1") + scale_fill_brewer(palette="Set1") + ylab("vx")
```

### Fitness relative variation vs. distance (for type+ctrl, iteration, softness)
```{r, fig.width=5, fig.height=3}
d2 %>% mutate(rfv = (pointQ-srcQ)/srcQ) %>% group_by(type, ctrl, softness, iteration, stepIndex, d) %>% summarise_at(vars(rfv), list(Q1=~quantile(.,probs=0.25), median=median, Q3=~quantile(.,probs=0.75))) %>% ggplot(aes(d,median,col=softness)) + geom_line() + geom_ribbon(aes(ymin=Q1,ymax=Q3,fill=softness),alpha=0.2,color=NA) + facet_grid(factor(iteration)~type+ctrl) + theme_light() + scale_color_brewer(palette="Set1") + scale_fill_brewer(palette="Set1")  + ylab("rfv")
```

### Partial information count / number of changes (on relative fitness variation)
This function returns the ratio between the number (`which(cc)` below) of direction change in a sequence of values and the length of the sequence.
A variation is not considered if it is smaller than `epsilon`.
```{r}
changes = function(values, epsilon) {
  v = values[2:length(values)]-values[1:(length(values)-1)];
  v[abs(v)<=epsilon] = 0;
  c = sign(v)
  c = c[c!=0]
  if (length(c)==0) {
    0
  } else if (length(c)<=2) {
    1/length(values)
  } else {
    cc = c[2:length(c)]!=c[1:(length(c)-1)]
    length(which(cc))/(length(values))
  }
}
```


## Ruggedness vs. iteration (for type+ctrl, ruggeness-threshold, softness)
```{r, fig.width=5, fig.height=4}
d2 %>% mutate(rfv = (pointQ-srcQ)/srcQ) %>% group_by(type, ctrl, softness, iteration, seed, dstIndex) %>% summarise_at(vars(rfv), list(c05=~changes(.,0.05), c10=~changes(.,0.10), c25=~changes(.,0.25), c50=~changes(.,0.50))) %>% pivot_longer(c(c05,c10,c25,c50)) %>% group_by(type, ctrl,softness,iteration,name) %>% summarise_at(vars(value), list(Q1=~quantile(.,probs=0.25), median=median, Q3=~quantile(.,probs=0.75))) %>% ggplot(aes(x=iteration,y=median,color=softness)) + geom_line()  + geom_ribbon(aes(ymin=Q1,ymax=Q3,fill=softness),alpha=0.2,color=NA) + facet_grid(name~type+ctrl)  + theme_light() + scale_color_brewer(palette="Set1") + scale_fill_brewer(palette="Set1") + ylab("ruggedness")
```

## Ruggedness vs. softness (for type+ctrl, ruggeness-threshold, iteration)
```{r, fig.width=5, fig.height=3}
d2 %>% mutate(rfv = (pointQ-srcQ)/srcQ) %>% group_by(type, ctrl, softness, iteration, seed, dstIndex) %>% summarise_at(vars(rfv), list(c05=~changes(.,0.05), c10=~changes(.,0.10), c25=~changes(.,0.25), c50=~changes(.,0.50))) %>% pivot_longer(c(c05,c10,c25,c50)) %>% group_by(type, ctrl,softness,iteration,name) %>% summarise_at(vars(value), list(Q1=~quantile(.,probs=0.25), median=median, Q3=~quantile(.,probs=0.75))) %>% ggplot(aes(x=as.numeric(softness),y=median,color=name)) + geom_line() + geom_ribbon(aes(ymin=Q1,ymax=Q3,fill=name),alpha=0.2,color=NA) + facet_grid(factor(iteration)~type+ctrl)  + theme_light() + scale_color_brewer(palette="Set1") + scale_fill_brewer(palette="Set1") + ylab("ruggedness")
```
