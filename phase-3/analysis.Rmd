---
title: "Evolution of the controller of hybrid (soft/rigid) robots"
output: html_notebook
---
```{r}
require(tidyverse)
require(skimr)
```

## Load and clean evolution data


### Load data
```{r}
r.legged = read.csv2("../phase-1/best-walker-3chunks-6x.csv", dec=".", strip.white = T, stringsAsFactors = T)
r.vsr = read.csv2("../phase-1/best-hybrid-vsr.csv", dec=".", strip.white = T, stringsAsFactors = T)
```

### Clean
Extract key factors.
```{r}
r.legged$type = "legged"
r.legged$softness = factor(str_count(r.legged$solver.mapper.target,"soft"))
r.legged$ctrl = "open"
r.vsr$type = "vsr"
r.vsr$softness = factor((str_count(r.vsr$solver.mapper.target.body.shape,"s")-8)/2)
r.vsr$ctrl = "open"
r.vsr$ctrl[r.vsr$solver.mapper.target.function=="s.f.mlp()"] = "closed"
vars = c("type", "ctrl", "softness", "randomGenerator.seed", "iterations", "evals", "best.fitness.s.task.l.xVelocity")
d = rbind(r.vsr[, vars], r.legged[, vars])
d$type = factor(d$type)
d$ctrl = factor(d$ctrl)
```

The **softness** is defined as follows:

For legged robots, it is the number of soft feet out of 5 total feet.

For VSRs, it corresponds to:
- for 0, 4 out of 12 soft voxels (i.e., 8 are rigid squares)
- for 1, 6 out of 12 soft voxels
- for 2, 8 out of 12 soft voxels
- for 3, 10 out of 12 soft voxels
- for 4, 12 out of 12 soft voxels

## Evolution plot

```{r, fig.width=10, fig.height=4}
d %>% group_by(type, ctrl, softness, iterations) %>% summarise_at(vars(best.fitness.s.task.l.xVelocity), list(Q1=~quantile(.,probs=0.25), median=median, Q3=~quantile(.,probs=0.75))) %>% ggplot(aes(iterations,median,col=softness)) + geom_line() + geom_ribbon(aes(ymin=Q1,ymax=Q3,fill=softness),alpha=0.2,color=NA) + facet_wrap(vars(type,ctrl), scales="free") + theme_light() + scale_color_brewer(palette="Set1") + scale_fill_brewer(palette="Set1")
```

## Box plots

```{r, fig.width=10, fig.height=4}
d %>% group_by(type, ctrl, softness, randomGenerator.seed) %>% arrange(iterations) %>% filter(row_number()==n()) %>% ungroup() %>% group_by(type, ctrl, softness) %>% ggplot(aes(x=softness,y=best.fitness.s.task.l.xVelocity)) + geom_boxplot() + facet_wrap(vars(type,ctrl), scales="free") + theme_light() + scale_color_brewer(palette="Set1") + scale_fill_brewer(palette="Set1")
```


# OLD!

## Sections plots

### Actual fitness average across destinations, randomSeed 
```{r, fig.width=10, fig.height=4}
gs1 = s %>% group_by(controller, nSoft, iteration, stepIndex,d) %>% summarise_at(vars(pointQ), list(Q1=~quantile(.,probs=0.25), median=median, Q3=~quantile(.,probs=0.75)))
gs1 %>% ggplot(aes(d,median,col=nSoft)) + geom_line() + geom_ribbon(aes(ymin=Q1,ymax=Q3,fill=nSoft),alpha=0.2,color=NA) + facet_grid(factor(iteration)~controller) + theme_light() + scale_color_brewer(palette="Set1") + scale_fill_brewer(palette="Set1")
```

### Fitness relative variation average across destinations, randomSeed 
```{r, fig.width=10, fig.height=4}
gs2 = s %>% group_by(controller, nSoft, iteration, stepIndex, d) %>% summarise_at(vars(rf), list(Q1=~quantile(.,probs=0.25), median=median, Q3=~quantile(.,probs=0.75)))
gs2 %>% ggplot(aes(d,median,col=nSoft)) + geom_line() + geom_ribbon(aes(ymin=Q1,ymax=Q3,fill=nSoft),alpha=0.2,color=NA) + facet_grid(factor(iteration)~controller) + theme_light() + scale_color_brewer(palette="Set1") + scale_fill_brewer(palette="Set1") + ylim(c(-1,1))
```

### Fitness relative variation for iteration==100, randomSeed==0
```{r, fig.width=10, fig.height=8}
gs3 = s %>% filter(iteration==100 & randomSeed==0)
gs3 %>% ggplot(aes(d,pointQ,col=nSoft)) + geom_line() + facet_grid(factor(dstIndex)~controller) + theme_light() + scale_color_brewer(palette="Set1") + scale_fill_brewer(palette="Set1")
```
```{r, fig.width=10, fig.height=8}
gs3 = s %>% filter(iteration==199 & randomSeed==1)
gs3 %>% ggplot(aes(d,f,col=factor(dstIndex))) + geom_line() + facet_grid(nSoft~controller) + theme_light() + scale_color_brewer(palette="Set1") + scale_fill_brewer(palette="Set1")
```


### Fitness relative variation for iteration==100
```{r, fig.width=10, fig.height=8}
gs4 = s %>% filter(iteration==100)
gs4 %>% ggplot(aes(d,f,col=nSoft)) + geom_line(aes(linetype=controller)) + facet_grid(factor(dstIndex)~factor(randomSeed)) + theme_light() + scale_color_brewer(palette="Set1") + scale_fill_brewer(palette="Set1")
```

### Partial information count / number of changes (on relative fitness variation)
This function returns the ratio between the number (`which(cc)` below) of direction change in a sequence of values and the length of the sequence.
A variation is not considered if it is smaller than `epsilon`.
```{r}
changes = function(values, epsilon) {
  v = values[2:length(values)]-values[1:(length(values)-1)];
  v[abs(v)<=epsilon] = 0;
  c = sign(v)
  c = c[c!=0]
  if (length(c)==0) {
    0
  } else if (length(c)<=2) {
    1/length(values)
  } else {
    cc = c[2:length(c)]!=c[1:(length(c)-1)]
    length(which(cc))/(length(values))
  }
}
```

```{r, fig.width=10, fig.height=4}
s %>% group_by(controller, nSoft, iteration, randomSeed, dstIndex) %>% summarise_at(vars(f), list(c10=~changes(.,0.10), c25=~changes(.,0.25), c50=~changes(.,0.50), c90=~changes(.,0.9))) %>% pivot_longer(c(c10,c25,c50,c90)) %>% group_by(controller,nSoft,iteration,name) %>% summarise_at(vars(value), list(Q1=~quantile(.,probs=0.25), median=median, Q3=~quantile(.,probs=0.75))) %>% ggplot(aes(x=iteration,y=median,color=nSoft)) + geom_line()  + geom_ribbon(aes(ymin=Q1,ymax=Q3,fill=nSoft),alpha=0.2,color=NA) + facet_grid(name~controller)  + theme_light() + scale_color_brewer(palette="Set1") + scale_fill_brewer(palette="Set1")
```
```{r, fig.width=10, fig.height=6}
s %>% group_by(controller, nSoft, iteration, randomSeed, dstIndex) %>% summarise_at(vars(f), list(c10=~changes(.,0.10), c25=~changes(.,0.25), c50=~changes(.,0.50), c90=~changes(.,0.9))) %>% pivot_longer(c(c10,c25,c50,c90)) %>% group_by(controller,nSoft,iteration,name) %>% ggplot(aes(x=factor(iteration),y=value,color=nSoft)) + geom_boxplot() + facet_grid(name~controller)  + theme_light() + scale_color_brewer(palette="Set1") + scale_fill_brewer(palette="Set1")
```
